<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\andre\Source\School\BDSA2021-FinalProject\WebService.Infrastructure\SearchAlgorithm.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// ***********************************************************************
// Assembly         : WebService.Infrastructure
// Author           : Group BTG
// Created          : 11-29-2021
//
// Last Modified By : Group BTG
// Last Modified On : 12-14-2021
// ***********************************************************************
// &lt;copyright file=&quot;SearchAlgorithm.cs&quot; company=&quot;BTG&quot;&gt;
//     Copyright (c) . All rights reserved.
// &lt;/copyright&gt;
// &lt;summary&gt;&lt;/summary&gt;
// ***********************************************************************

namespace WebService.Infrastructure;

/// &lt;summary&gt;
///     Class SearchAlgorithm.
///     Implements the &lt;see cref=&quot;WebService.Core.Shared.ISearch&quot; /&gt;
/// &lt;/summary&gt;
/// &lt;seealso cref=&quot;WebService.Core.Shared.ISearch&quot; /&gt;
public class SearchAlgorithm : ISearch
{
    /// &lt;summary&gt;
    ///     The weighted tag score
    /// &lt;/summary&gt;
    private const float WeightedTagScore = 10;

    /// &lt;summary&gt;
    ///     The rating score
    /// &lt;/summary&gt;
    private const float RatingScore = 10;

    /// &lt;summary&gt;
    ///     The level score
    /// &lt;/summary&gt;
    private const float LevelScore = 50;

    /// &lt;summary&gt;
    ///     The programming language score
    /// &lt;/summary&gt;
    private const float ProgrammingLanguageScore = 100;

    /// &lt;summary&gt;
    ///     The media score
    /// &lt;/summary&gt;
    private const float MediaScore = 50;

    /// &lt;summary&gt;
    ///     The title score
    /// &lt;/summary&gt;
    private const float TitleScore = 300;

    /// &lt;summary&gt;
    ///     The author score
    /// &lt;/summary&gt;
    private const float AuthorScore = 300;

    /// &lt;summary&gt;
    ///     The timestamp score
    /// &lt;/summary&gt;
    private const float TimestampScore = -5;

    /// &lt;summary&gt;
    ///     The map
    /// &lt;/summary&gt;
    private readonly ConcurrentDictionary&lt;MaterialDTO, float&gt; _map;

    /// &lt;summary&gt;
    ///     The repository
    /// &lt;/summary&gt;
    private readonly IMaterialRepository _repository;

    /// &lt;summary&gt;
    ///     The tag repository
    /// &lt;/summary&gt;
    private readonly ITagRepository _tagRepository;

    /// &lt;summary&gt;
    ///     Initializes a new instance of the &lt;see cref=&quot;SearchAlgorithm&quot; /&gt; class.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;materialRepository&quot;&gt;The material repository.&lt;/param&gt;
    /// &lt;param name=&quot;tagRepository&quot;&gt;The tag repository.&lt;/param&gt;
    public SearchAlgorithm(IMaterialRepository materialRepository, ITagRepository tagRepository)
    {
        _repository = materialRepository;
        _tagRepository = tagRepository;
        _map = new ConcurrentDictionary&lt;MaterialDTO, float&gt;();
    }

    /// &lt;summary&gt;
    ///     Searches the specified search form and gets matching material.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;searchForm&quot;&gt;The search form.&lt;/param&gt;
    /// &lt;returns&gt;Task&amp;lt;System.ValueTuple&amp;lt;Status, ICollection&amp;lt;MaterialDTO&amp;gt;&amp;gt;&amp;gt;.&lt;/returns&gt;
    public async Task&lt;(Status, ICollection&lt;MaterialDTO&gt;)&gt; Search(SearchForm searchForm)
    {
        searchForm.TextField = searchForm.TextField.Replace(&quot;,&quot;, &quot;&quot;);
        searchForm = await AddTagsToSearchFromTextField(searchForm);
        var (status, materialDTOs) = await _repository.ReadAsync(searchForm);
        ICollection&lt;MaterialDTO&gt; materials = new List&lt;MaterialDTO&gt;(materialDTOs);

        if (status == Status.NotFound) return (Status.NotFound, materials);

        materials = FilterLanguage(materials, searchForm);

        if (!materials.Any()) return (Status.NotFound, materials);

        foreach (var material in materials) _map[material] = 0;

        PrioritizeMaterials(searchForm);

        materials = _map.OrderByDescending(e =&gt; e.Value).ThenBy(e =&gt; e.Key.Title).Select(e =&gt; e.Key).ToList();

        return (Status.Found, materials);
    }

    /// &lt;summary&gt;
    ///     Adds the tags to search from text field.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;searchForm&quot;&gt;The search form.&lt;/param&gt;
    /// &lt;returns&gt;SearchForm.&lt;/returns&gt;
    private async Task&lt;SearchForm&gt; AddTagsToSearchFromTextField(SearchForm searchForm)
    {
        var tags = await _tagRepository.ReadAsync();
        var foundWordsToTags = new HashSet&lt;TagDTO&gt;(searchForm.Tags);

        foreach (var word in searchForm.TextField.Split(&quot; &quot;))
            if (tags.Select(e =&gt; e.Name).ContainsIgnoreCasing(word))
                foundWordsToTags.Add(tags.First(e =&gt; e.Name.IsEqualIgnoreCasing(word)));
        searchForm.Tags = foundWordsToTags.ToList();
        return searchForm;
    }

    /// &lt;summary&gt;
    ///     Prioritizes the materials.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;searchForm&quot;&gt;The search form.&lt;/param&gt;
    private void PrioritizeMaterials(SearchForm searchForm)
    {
        Parallel.Invoke(
            SetScoreRating,
            () =&gt; SetScoreAuthor(searchForm),
            () =&gt; SetScoreLevel(searchForm),
            () =&gt; SetScoreMedia(searchForm),
            () =&gt; SetScoreProgrammingLanguage(searchForm),
            SetScoreTimestamp,
            () =&gt; SetScoreTitle(searchForm),
            () =&gt; SetScoreWeightedTags(searchForm)
        );
    }

    /// &lt;summary&gt;
    ///     Filters the language.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;materials&quot;&gt;The materials.&lt;/param&gt;
    /// &lt;param name=&quot;searchForm&quot;&gt;The search form.&lt;/param&gt;
    /// &lt;returns&gt;ICollection&amp;lt;MaterialDTO&amp;gt;.&lt;/returns&gt;
    private static ICollection&lt;MaterialDTO&gt; FilterLanguage(ICollection&lt;MaterialDTO&gt; materials, SearchForm searchForm)
    {
        if (!searchForm.Languages.Any()) return materials;

        return materials.Where(m =&gt; searchForm.Languages.Select(e =&gt; e.Name).ContainsIgnoreCasing(m.Language.Name))
            .ToList();
    }

    /// &lt;summary&gt;
    ///     Sets the score for weighted tags.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;searchForm&quot;&gt;The search form.&lt;/param&gt;
    private void SetScoreWeightedTags(SearchForm searchForm)
    {
        foreach (var material in _map.Keys)
        {
            var weightSum = material.Tags
                .Where(materialTag =&gt; searchForm.Tags.Select(searchFormTag =&gt; searchFormTag.Name)
                    .ContainsIgnoreCasing(materialTag.Name)).ToList().Select(tag =&gt; tag.Weight).Sum();
            var tagCount = material.Tags
                .Count(materialTag =&gt; searchForm.Tags.Select(searchFormTag =&gt; searchFormTag.Name)
                    .ContainsIgnoreCasing(materialTag.Name));
            UpdateMap(material, weightSum * WeightedTagScore * tagCount);
        }
    }

    /// &lt;summary&gt;
    ///     Sets the score for rating.
    /// &lt;/summary&gt;
    private void SetScoreRating()
    {
        foreach (var material in _map.Keys) UpdateMap(material, material.AverageRating() * RatingScore);
    }

    /// &lt;summary&gt;
    ///     Sets the score for level.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;searchForm&quot;&gt;The search form.&lt;/param&gt;
    private void SetScoreLevel(SearchForm searchForm)
    {
        foreach (var material in _map.Keys)
        {
            var count = material.Levels
                .Count(e =&gt; searchForm.Levels.Select(levelDTO =&gt; levelDTO.Name).ContainsIgnoreCasing(e.Name));
            UpdateMap(material, count * LevelScore);
        }
    }

    /// &lt;summary&gt;
    ///     Sets the score for programming language.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;searchForm&quot;&gt;The search form.&lt;/param&gt;
    private void SetScoreProgrammingLanguage(SearchForm searchForm)
    {
        foreach (var material in _map.Keys)
        {
            var count = material.ProgrammingLanguages.Count(e =&gt;
                searchForm.ProgrammingLanguages.Select(programmingLanguageDTO =&gt; programmingLanguageDTO.Name)
                    .ContainsIgnoreCasing(e.Name));
            UpdateMap(material, count * ProgrammingLanguageScore);
        }
    }

    /// &lt;summary&gt;
    ///     Sets the score for media.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;searchForm&quot;&gt;The search form.&lt;/param&gt;
    private void SetScoreMedia(SearchForm searchForm)
    {
        foreach (var material in _map.Keys)
        {
            var count = material.Medias
                .Count(e =&gt; searchForm.Medias.Select(mediaDTO =&gt; mediaDTO.Name).ContainsIgnoreCasing(e.Name));
            UpdateMap(material, count * MediaScore);
        }
    }

    /// &lt;summary&gt;
    ///     Sets the score for title.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;searchForm&quot;&gt;The search form.&lt;/param&gt;
    private void SetScoreTitle(SearchForm searchForm)
    {
        foreach (var material in _map.Keys)
        {
            float wordCount = 0;
            float textFieldCount = searchForm.TextField.Split(&quot; &quot;).Length;
            foreach (var word in material.Title.Split(&quot; &quot;))
                if (searchForm.TextField.ContainsIgnoreCasing(word))
                    wordCount++;
            UpdateMap(material, wordCount / textFieldCount * TitleScore);
        }
    }

    /// &lt;summary&gt;
    ///     Sets the score for author.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;searchForm&quot;&gt;The search form.&lt;/param&gt;
    private void SetScoreAuthor(SearchForm searchForm)
    {
        foreach (var material in _map.Keys)
        {
            var authorNameCount = 0;

            foreach (var author in material.Authors)
            {
                if (searchForm.TextField.ContainsIgnoreCasing(author.FirstName)) authorNameCount++;

                if (searchForm.TextField.ContainsIgnoreCasing(author.SurName)) authorNameCount++;
            }

            UpdateMap(material, authorNameCount * AuthorScore);
        }
    }

    /// &lt;summary&gt;
    ///     Sets the score for timestamp.
    /// &lt;/summary&gt;
    private void SetScoreTimestamp()
    {
        foreach (var material in _map.Keys)
        {
            var yearDifference = DateTime.UtcNow.Year - material.TimeStamp.Year;
            UpdateMap(material, yearDifference * TimestampScore);
        }
    }

    /// &lt;summary&gt;
    ///     Updates the map.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;key&quot;&gt;The key.&lt;/param&gt;
    /// &lt;param name=&quot;addValue&quot;&gt;The add value.&lt;/param&gt;
    private void UpdateMap(MaterialDTO key, float addValue)
    {
        _map.AddOrUpdate(key, 0, (_, current) =&gt; current + addValue);
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[84,5,84,97,1],[85,5,85,6,1],[86,9,86,42,1],[87,9,87,40,1],[88,9,88,63,1],[89,5,89,6,1],[97,5,97,6,1],[98,9,98,70,1],[99,9,99,69,1],[100,9,100,78,1],[101,9,101,82,1],[103,9,103,39,1],[103,40,103,76,1],[105,9,105,59,1],[107,9,107,30,1],[107,31,107,67,1],[109,9,109,16,1],[109,18,109,30,1],[109,31,109,33,1],[109,34,109,43,1],[109,45,109,64,1],[111,9,111,41,1],[113,9,113,49,1],[113,49,113,56,1],[113,56,113,70,1],[113,70,113,81,1],[113,81,113,95,1],[113,95,113,100,1],[113,100,113,111,1],[115,9,115,42,1],[116,5,116,6,1],[124,5,124,6,1],[125,9,125,53,1],[126,9,126,69,1],[128,9,128,16,1],[128,18,128,26,1],[128,27,128,29,1],[128,30,128,61,1],[129,13,129,34,1],[129,34,129,40,1],[129,40,129,69,1],[130,17,130,54,1],[130,54,130,86,1],[130,86,130,89,1],[131,9,131,53,1],[132,9,132,27,1],[133,5,133,6,1],[140,5,140,6,1],[141,9,143,19,1],[143,19,143,45,1],[143,45,144,19,1],[144,19,144,44,1],[144,44,145,19,1],[145,19,145,44,1],[145,44,146,19,1],[146,19,146,58,1],[146,58,148,19,1],[148,19,148,44,1],[148,44,149,19,1],[149,19,149,51,1],[149,51,150,11,1],[151,5,151,6,1],[160,5,160,6,1],[161,9,161,41,1],[161,42,161,59,1],[163,9,163,37,1],[163,37,163,70,1],[163,70,163,76,1],[163,76,163,115,1],[163,115,164,23,1],[165,5,165,6,1],[172,5,172,6,1],[173,9,173,16,1],[173,18,173,30,1],[173,31,173,33,1],[173,34,173,43,1],[174,9,174,10,1],[175,13,176,39,1],[176,39,176,79,1],[176,79,176,97,1],[176,97,177,60,1],[177,60,177,85,1],[177,85,177,95,1],[177,95,177,103,1],[178,13,179,39,1],[179,39,179,79,1],[179,79,179,97,1],[179,97,180,60,1],[180,60,180,62,1],[181,13,181,74,1],[182,9,182,10,1],[183,5,183,6,1],[189,5,189,6,1],[190,9,190,16,1],[190,18,190,30,1],[190,31,190,33,1],[190,34,190,43,1],[190,45,190,105,1],[191,5,191,6,1],[198,5,198,6,1],[199,9,199,16,1],[199,18,199,30,1],[199,31,199,33,1],[199,34,199,43,1],[200,9,200,10,1],[201,13,202,29,1],[202,29,202,66,1],[202,66,202,79,1],[202,79,202,109,1],[202,109,202,111,1],[203,13,203,53,1],[204,9,204,10,1],[205,5,205,6,1],[212,5,212,6,1],[213,9,213,16,1],[213,18,213,30,1],[213,31,213,33,1],[213,34,213,43,1],[214,9,214,10,1],[215,13,216,17,1],[216,17,216,82,1],[216,82,216,109,1],[216,109,217,50,1],[217,50,217,52,1],[218,13,218,67,1],[219,9,219,10,1],[220,5,220,6,1],[227,5,227,6,1],[228,9,228,16,1],[228,18,228,30,1],[228,31,228,33,1],[228,34,228,43,1],[229,9,229,10,1],[230,13,231,29,1],[231,29,231,66,1],[231,66,231,79,1],[231,79,231,109,1],[231,109,231,111,1],[232,13,232,53,1],[233,9,233,10,1],[234,5,234,6,1],[241,5,241,6,1],[242,9,242,16,1],[242,18,242,30,1],[242,31,242,33,1],[242,34,242,43,1],[243,9,243,10,1],[244,13,244,33,1],[245,13,245,75,1],[246,13,246,20,1],[246,22,246,30,1],[246,31,246,33,1],[246,34,246,59,1],[247,17,247,69,1],[248,21,248,33,1],[249,13,249,74,1],[250,9,250,10,1],[251,5,251,6,1],[258,5,258,6,1],[259,9,259,16,1],[259,18,259,30,1],[259,31,259,33,1],[259,34,259,43,1],[260,9,260,10,1],[261,13,261,37,1],[263,13,263,20,1],[263,22,263,32,1],[263,33,263,35,1],[263,36,263,52,1],[264,13,264,14,1],[265,17,265,81,1],[265,82,265,100,1],[267,17,267,79,1],[267,80,267,98,1],[268,13,268,14,1],[270,13,270,64,1],[271,9,271,10,1],[272,5,272,6,1],[278,5,278,6,1],[279,9,279,16,1],[279,18,279,30,1],[279,31,279,33,1],[279,34,279,43,1],[280,9,280,10,1],[281,13,281,81,1],[282,13,282,66,1],[283,9,283,10,1],[284,5,284,6,1],[292,5,292,6,1],[293,9,293,50,1],[293,50,293,68,1],[293,68,293,70,1],[294,5,294,6,1]]);
    </script>
  </body>
</html>