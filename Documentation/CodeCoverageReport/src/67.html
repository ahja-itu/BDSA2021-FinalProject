<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\andre\Source\School\BDSA2021-FinalProject\WebService.Core\Server\Model\SeedExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// ***********************************************************************
// Assembly         : WebService.Core.Server
// Author           : Group BTG
// Created          : 12-10-2021
//
// Last Modified By : Group BTG
// Last Modified On : 12-14-2021
// ***********************************************************************
// &lt;copyright file=&quot;SeedExtensions.cs&quot; company=&quot;BTG&quot;&gt;
//     Copyright (c) . All rights reserved.
// &lt;/copyright&gt;
// &lt;summary&gt;&lt;/summary&gt;
// ***********************************************************************

using Microsoft.VisualBasic.FileIO;

namespace WebService.Core.Server.Model;

/// Idea taken from https://github.com/ondfisk/BDSA2021/blob/3fe02352710a920bfb874ed1b219d273a26a92d2/MyApp.Server/Model/SeedExtensions.cs#L3
/// Thank you, OndFisk
/// &lt;summary&gt;
///     Class SeedExtensions.
/// &lt;/summary&gt;
public static class SeedExtensions
{
    /// &lt;summary&gt;
    ///     Removes all items from the database and reseeds it with randomly generated materials from specific tags saved in
    ///     the data files found in the data directory.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;host&quot;&gt;The host object containing IoT containers such as the DbContext and repositories.&lt;/param&gt;
    /// &lt;param name=&quot;environment&quot;&gt;The environment.&lt;/param&gt;
    /// &lt;returns&gt;A Task representing the asynchronous operation.&lt;/returns&gt;
    public static async Task SeedAsync(this IHost host, IWebHostEnvironment environment)
    {
        using var scope = host.Services.CreateScope();
        var context = scope.ServiceProvider.GetRequiredService&lt;IContext&gt;();

        var contentGenerator = new ContentGenerator(environment);

        var languageRepository = scope.ServiceProvider.GetRequiredService&lt;ILanguageRepository&gt;();
        var levelRepository = scope.ServiceProvider.GetRequiredService&lt;ILevelRepository&gt;();
        var mediaRepository = scope.ServiceProvider.GetRequiredService&lt;IMediaRepository&gt;();
        var plRepository = scope.ServiceProvider.GetRequiredService&lt;IProgrammingLanguageRepository&gt;();
        var tagRepository = scope.ServiceProvider.GetRequiredService&lt;ITagRepository&gt;();
        var materialRepository = scope.ServiceProvider.GetRequiredService&lt;IMaterialRepository&gt;();

        var repos = new Dictionary&lt;RepoType, IRepository&gt;
        {
            {RepoType.Tag, tagRepository},
            {RepoType.Level, levelRepository},
            {RepoType.Language, languageRepository},
            {RepoType.ProgrammingLanguage, plRepository},
            {RepoType.Media, mediaRepository},
            {RepoType.Material, materialRepository}
        };

        await CleanDB(context);

        await SeedLanguagesAsync(languageRepository);
        await SeedLevelsAsync(levelRepository);
        await SeedMediaAsync(mediaRepository);
        await SeedProgrammingLanguagesAsync(plRepository);
        await SeedTagsAsync(tagRepository);
        await SeedMaterial(repos, contentGenerator);
    }

    /// &lt;summary&gt;
    ///     Cleans the database.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;context&quot;&gt;The context.&lt;/param&gt;
    private static async Task CleanDB(IContext context)
    {
        context.Languages.RemoveRange(context.Languages);
        context.Levels.RemoveRange(context.Levels);
        context.Materials.RemoveRange(context.Materials);
        context.Medias.RemoveRange(context.Medias);
        context.ProgrammingLanguages.RemoveRange(context.ProgrammingLanguages);
        context.Tags.RemoveRange(context.Tags);
        await context.SaveChangesAsync();
    }

    /// &lt;summary&gt;
    ///     Seeds the material.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;repos&quot;&gt;The repos.&lt;/param&gt;
    /// &lt;param name=&quot;contentGenerator&quot;&gt;The content generator.&lt;/param&gt;
    private static async Task SeedMaterial(Dictionary&lt;RepoType, IRepository&gt; repos, ContentGenerator contentGenerator)
    {
        var tagRepo = GetRepo&lt;ITagRepository&gt;(repos, RepoType.Tag);
        var languageRepository = GetRepo&lt;ILanguageRepository&gt;(repos, RepoType.Language);
        var levelRepository = GetRepo&lt;ILevelRepository&gt;(repos, RepoType.Level);
        var mediaRepository = GetRepo&lt;IMediaRepository&gt;(repos, RepoType.Media);
        var plRepository = GetRepo&lt;IProgrammingLanguageRepository&gt;(repos, RepoType.ProgrammingLanguage);
        var materialRepository = GetRepo&lt;IMaterialRepository&gt;(repos, RepoType.Material);

        var rand = new Random();
        var authors = LoadAuthors();
        var names = LoadNames();

        var tags = await tagRepo.ReadAsync();
        var level = await levelRepository.ReadAsync();
        var programmingLanguages = await plRepository.ReadAsync();
        var medias = await mediaRepository.ReadAsync();
        var languages = await languageRepository.ReadAsync();

        // Lets create a material for each author
        foreach (var author in authors)
        {
            var tagCount = 1 + rand.Next(4); // number 1 -&gt; 4
            var ratingsCount = rand.Next(21); // 0 -&gt; 20

            // ratings, weighted tags, author are owned properties of a material,
            // so we need to create them on a per material basis

            var weightedTags = GetNRandomEntries(tags, tagCount)
                .Select(t =&gt; new CreateWeightedTagDTO(t.Name, rand.Next(101)))
                .ToList();

            var ratings = GetNRandomEntries(names, ratingsCount)
                .Select(name =&gt; new CreateRatingDTO(rand.Next(11), name))
                .ToList();

            var assignedLevel = GetNRandomEntries&lt;CreateLevelDTO&gt;(level, 1);

            var assignedPl = GetNRandomEntries&lt;CreateProgrammingLanguageDTO&gt;(programmingLanguages, 1);

            var assignedMediaType = GetNRandomEntries&lt;CreateMediaDTO&gt;(medias, 1);

            var assignedLanguage = GetSingleRandomEntry&lt;CreateLanguageDTO&gt;(languages);

            // Visual Studio complains later that assignedLanguage might be null, so lets ensure it wont be
            if (assignedLanguage == null)
            {
                var safetyCounter = 0;
                while (assignedLanguage == null || safetyCounter++ &lt; 100)
                    assignedLanguage = GetSingleRandomEntry&lt;CreateLanguageDTO&gt;(languages);

                if (safetyCounter &gt;= 100)
                    // We must have exited the while loop above due to the safetyCounter
                    // reaching its limit. 
                    continue;
            }

            var (convertOk, lang) = ContentGenerator.StringToLanguage(assignedLanguage.Name);
            if (!convertOk)
                Console.WriteLine(
                    &quot;Could not convert given language for the material to the ENUM representation. Skipping this material&quot;);


            var (contentOk, content) = contentGenerator.GenerateText(lang, 100 + rand.Next(300));
            if (!contentOk)
            {
                Console.WriteLine(&quot;Failed to generate text for a material. Skipping this material.&quot;);
                continue;
            }

            var summaryWords = content.Split(&#39; &#39;).Take(30).ToList();
            var summary = string.Join(&#39; &#39;, summaryWords) + &quot;...&quot;;
            const string url = &quot;https://www.youtube.com/watch?v=dQw4w9WgXcQ&quot;;

            // Ensure title will be created
            var (titleOk, title) = ContentGenerator.GenerateTitle(weightedTags);
            if (!titleOk)
            {
                Console.WriteLine(&quot;Failed to generate title with given input. Skipping this material.&quot;);
                continue;
            }

            var authorsList = new List&lt;CreateAuthorDTO&gt; {new(author.FirstName, author.SurName)};

            // Created at can be within the last 5 years
            var createdAt = DateTime.Now.AddMinutes(-rand.NextDouble() * 525_948 * 5);

            var material = new CreateMaterialDTO(weightedTags,
                ratings,
                assignedLevel,
                assignedPl,
                assignedMediaType,
                assignedLanguage,
                summary,
                url,
                content,
                title,
                authorsList,
                createdAt);

            await materialRepository.CreateAsync(material);
        }
    }

    /// &lt;summary&gt;
    ///     Loads the names.
    /// &lt;/summary&gt;
    /// &lt;returns&gt;List&amp;lt;System.String&amp;gt;.&lt;/returns&gt;
    private static List&lt;string&gt; LoadNames()
    {
        return ReadCSV(&quot;names.csv&quot;, 2)
            .Select(fields =&gt; fields[1])
            .ToList();
    }

    /// &lt;summary&gt;
    ///     Loads the authors.
    /// &lt;/summary&gt;
    /// &lt;returns&gt;List&amp;lt;Author&amp;gt;.&lt;/returns&gt;
    private static List&lt;Author&gt; LoadAuthors()
    {
        return ReadCSV(&quot;authors.csv&quot;, 2)
            .Select(fields =&gt; new Author(fields[0], fields[1]))
            .ToList();
    }

    /// &lt;summary&gt;
    ///     Seed languages as an asynchronous operation.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;repo&quot;&gt;The repo.&lt;/param&gt;
    /// &lt;returns&gt;A Task representing the asynchronous operation.&lt;/returns&gt;
    private static async Task SeedLanguagesAsync(ILanguageRepository repo)
    {
        foreach (var fields in ReadCSV(&quot;languages.csv&quot;, 2))
        {
            var name = fields[1];

            var language = new CreateLanguageDTO(name);
            await repo.CreateAsync(language);
        }
    }

    /// &lt;summary&gt;
    ///     Seed levels as an asynchronous operation.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;repo&quot;&gt;The repo.&lt;/param&gt;
    /// &lt;returns&gt;A Task representing the asynchronous operation.&lt;/returns&gt;
    private static async Task SeedLevelsAsync(ILevelRepository repo)
    {
        foreach (var fields in ReadCSV(&quot;levels.csv&quot;, 2))
        {
            var name = fields[1];

            var level = new CreateLevelDTO(name);
            await repo.CreateAsync(level);
        }
    }


    /// &lt;summary&gt;
    ///     Seed media as an asynchronous operation.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;repo&quot;&gt;The repo.&lt;/param&gt;
    /// &lt;returns&gt;A Task representing the asynchronous operation.&lt;/returns&gt;
    private static async Task SeedMediaAsync(IMediaRepository repo)
    {
        foreach (var fields in ReadCSV(&quot;media.csv&quot;, 2))
        {
            var type = fields[1];

            var media = new CreateMediaDTO(type);
            await repo.CreateAsync(media);
        }
    }

    /// &lt;summary&gt;
    ///     Seed programming languages as an asynchronous operation.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;repo&quot;&gt;The repo.&lt;/param&gt;
    /// &lt;returns&gt;A Task representing the asynchronous operation.&lt;/returns&gt;
    private static async Task SeedProgrammingLanguagesAsync(IProgrammingLanguageRepository repo)
    {
        // ReSharper disable once StringLiteralTypo
        foreach (var fields in ReadCSV(&quot;programminglanguages.csv&quot;, 1))
        {
            var name = fields[0];

            var pl = new CreateProgrammingLanguageDTO(name);
            await repo.CreateAsync(pl);
        }
    }

    /// &lt;summary&gt;
    ///     Seed tags as an asynchronous operation.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;repo&quot;&gt;The repo.&lt;/param&gt;
    /// &lt;returns&gt;A Task representing the asynchronous operation.&lt;/returns&gt;
    private static async Task SeedTagsAsync(ITagRepository repo)
    {
        foreach (var fields in ReadCSV(&quot;tags.csv&quot;, 1))
        {
            var name = fields[0];

            var tag = new CreateTagDTO(name);
            await repo.CreateAsync(tag);
        }
    }

    /// &lt;summary&gt;
    ///     Gets the n random entries.
    /// &lt;/summary&gt;
    /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
    /// &lt;param name=&quot;entries&quot;&gt;The entries.&lt;/param&gt;
    /// &lt;param name=&quot;n&quot;&gt;The n.&lt;/param&gt;
    /// &lt;returns&gt;ICollection&amp;lt;T&amp;gt;.&lt;/returns&gt;
    private static ICollection&lt;T&gt; GetNRandomEntries&lt;T&gt;(IEnumerable&lt;T&gt; entries, int n)
    {
        return entries.OrderBy(_ =&gt; Guid.NewGuid()).Take(n).ToList();
    }

    /// &lt;summary&gt;
    ///     Gets the single random entry.
    /// &lt;/summary&gt;
    /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
    /// &lt;param name=&quot;entries&quot;&gt;The entries.&lt;/param&gt;
    /// &lt;returns&gt;System.Nullable&amp;lt;T&amp;gt;.&lt;/returns&gt;
    private static T? GetSingleRandomEntry&lt;T&gt;(IEnumerable&lt;T&gt; entries)
    {
        return entries.OrderBy(_ =&gt; Guid.NewGuid()).FirstOrDefault();
    }

    /// &lt;summary&gt;
    ///     Gets the repo.
    /// &lt;/summary&gt;
    /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
    /// &lt;param name=&quot;repos&quot;&gt;The repos.&lt;/param&gt;
    /// &lt;param name=&quot;type&quot;&gt;The type.&lt;/param&gt;
    /// &lt;returns&gt;T.&lt;/returns&gt;
    private static T GetRepo&lt;T&gt;(Dictionary&lt;RepoType, IRepository&gt; repos, RepoType type)
    {
        return repos.Where(kv =&gt; kv.Key == type).Select(kv =&gt; (T) kv.Value).First();
    }

    /// &lt;summary&gt;
    ///     Reads the CSV.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;filename&quot;&gt;The filename.&lt;/param&gt;
    /// &lt;param name=&quot;fieldCount&quot;&gt;The field count.&lt;/param&gt;
    /// &lt;returns&gt;IEnumerable&amp;lt;System.String[]&amp;gt;.&lt;/returns&gt;
    private static IEnumerable&lt;string[]&gt; ReadCSV(string filename, uint fieldCount)
    {
        using var csvParser = new TextFieldParser(GetDataFileLocation(filename));
        csvParser.CommentTokens = new[] {&quot;#&quot;};
        csvParser.SetDelimiters(&quot;,&quot;);
        csvParser.HasFieldsEnclosedInQuotes = false;

        csvParser.ReadLine();
        while (!csvParser.EndOfData)
        {
            var fields = csvParser.ReadFields() ?? new string[fieldCount];
            if (IsAllNonEmpty(fields)) yield return fields;
        }
    }

    /// &lt;summary&gt;
    ///     Determines whether [is all non empty] [the specified fields].
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;fields&quot;&gt;The fields.&lt;/param&gt;
    /// &lt;returns&gt;&lt;c&gt;true&lt;/c&gt; if [is all non empty] [the specified fields]; otherwise, &lt;c&gt;false&lt;/c&gt;.&lt;/returns&gt;
    private static bool IsAllNonEmpty(params string[] fields)
    {
        return fields.All(field =&gt; field.Trim().Length &gt; 0);
    }

    /// &lt;summary&gt;
    ///     Gets the data file location.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;filename&quot;&gt;The filename.&lt;/param&gt;
    /// &lt;returns&gt;System.String.&lt;/returns&gt;
    private static string GetDataFileLocation(string filename)
    {
        return $&quot;{Directory.GetCurrentDirectory()}/../../data/{filename}&quot;;
    }

    /// &lt;summary&gt;
    ///     Enum RepoType
    /// &lt;/summary&gt;
    private enum RepoType
    {
        Language,
        Level,
        Media,
        ProgrammingLanguage,
        Tag,
        Material
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[34,5,34,6,0],[35,9,35,55,0],[36,9,36,76,0],[38,9,38,66,0],[40,9,40,98,0],[41,9,41,92,0],[42,9,42,92,0],[43,9,43,103,0],[44,9,44,88,0],[45,9,45,98,0],[47,9,55,11,0],[57,9,57,32,0],[59,9,59,54,0],[60,9,60,48,0],[61,9,61,47,0],[62,9,62,59,0],[63,9,63,44,0],[64,9,64,53,0],[65,5,65,6,0],[72,5,72,6,0],[73,9,73,58,0],[74,9,74,52,0],[75,9,75,58,0],[76,9,76,52,0],[77,9,77,80,0],[78,9,78,48,0],[79,9,79,42,0],[80,5,80,6,0],[88,5,88,6,0],[89,9,89,68,0],[90,9,90,89,0],[91,9,91,80,0],[92,9,92,80,0],[93,9,93,105,0],[94,9,94,89,0],[96,9,96,33,0],[97,9,97,37,0],[98,9,98,33,0],[100,9,100,46,0],[101,9,101,55,0],[102,9,102,67,0],[103,9,103,56,0],[104,9,104,62,0],[107,9,107,16,0],[107,18,107,28,0],[107,29,107,31,0],[107,32,107,39,0],[108,9,108,10,0],[109,13,109,45,0],[110,13,110,46,0],[115,13,116,30,0],[116,30,116,78,0],[116,78,117,27,0],[119,13,120,33,0],[120,33,120,73,0],[120,73,121,27,0],[123,13,123,77,0],[125,13,125,103,0],[127,13,127,82,0],[129,13,129,87,0],[132,13,132,42,0],[133,13,133,14,0],[134,17,134,39,0],[135,17,135,74,0],[136,21,136,91,0],[138,17,138,42,0],[141,21,141,30,0],[142,13,142,14,0],[144,13,144,94,0],[145,13,145,28,0],[146,17,147,125,0],[150,13,150,98,0],[151,13,151,28,0],[152,13,152,14,0],[153,17,153,102,0],[154,17,154,26,0],[157,13,157,69,0],[158,13,158,66,0],[162,13,162,81,0],[163,13,163,26,0],[164,13,164,14,0],[165,17,165,105,0],[166,17,166,26,0],[169,13,169,97,0],[172,13,172,87,0],[174,13,185,28,0],[187,13,187,60,0],[188,9,188,10,0],[189,5,189,6,0],[196,5,196,6,0],[197,9,198,31,0],[198,31,198,40,0],[198,40,199,23,0],[200,5,200,6,0],[207,5,207,6,0],[208,9,209,31,0],[209,31,209,63,0],[209,63,210,23,0],[211,5,211,6,0],[219,5,219,6,0],[220,9,220,16,0],[220,18,220,28,0],[220,29,220,31,0],[220,32,220,59,0],[221,9,221,10,0],[222,13,222,34,0],[224,13,224,56,0],[225,13,225,46,0],[226,9,226,10,0],[227,5,227,6,0],[235,5,235,6,0],[236,9,236,16,0],[236,18,236,28,0],[236,29,236,31,0],[236,32,236,56,0],[237,9,237,10,0],[238,13,238,34,0],[240,13,240,50,0],[241,13,241,43,0],[242,9,242,10,0],[243,5,243,6,0],[252,5,252,6,0],[253,9,253,16,0],[253,18,253,28,0],[253,29,253,31,0],[253,32,253,55,0],[254,9,254,10,0],[255,13,255,34,0],[257,13,257,50,0],[258,13,258,43,0],[259,9,259,10,0],[260,5,260,6,0],[268,5,268,6,0],[270,9,270,16,0],[270,18,270,28,0],[270,29,270,31,0],[270,32,270,70,0],[271,9,271,10,0],[272,13,272,34,0],[274,13,274,61,0],[275,13,275,40,0],[276,9,276,10,0],[277,5,277,6,0],[285,5,285,6,0],[286,9,286,16,0],[286,18,286,28,0],[286,29,286,31,0],[286,32,286,54,0],[287,9,287,10,0],[288,13,288,34,0],[290,13,290,46,0],[291,13,291,41,0],[292,9,292,10,0],[293,5,293,6,0],[303,5,303,6,0],[304,9,304,37,0],[304,37,304,51,0],[304,51,304,70,0],[305,5,305,6,0],[314,5,314,6,0],[315,9,315,37,0],[315,37,315,51,0],[315,51,315,70,0],[316,5,316,6,0],[326,5,326,6,0],[327,9,327,34,0],[327,34,327,48,0],[327,48,327,63,0],[327,63,327,75,0],[327,75,327,85,0],[328,5,328,6,0],[337,5,337,6,0],[338,9,338,82,0],[339,9,339,47,0],[340,9,340,38,0],[341,9,341,53,0],[343,9,343,30,0],[344,9,344,37,0],[345,9,345,10,0],[346,13,346,75,0],[347,13,347,39,0],[347,40,347,60,0],[348,9,348,10,0],[349,5,349,6,0],[357,5,357,6,0],[358,9,358,36,0],[358,36,358,59,0],[358,59,358,61,0],[359,5,359,6,0],[367,5,367,6,0],[368,9,368,75,0],[369,5,369,6,0]]);
    </script>
  </body>
</html>